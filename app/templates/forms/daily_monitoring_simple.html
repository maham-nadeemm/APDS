{% extends "base.html" %}

{% block title %}Daily Monitoring{% endblock %}

{% block sidebar_menu %}
<a href="{{ url_for('dashboard.technician_dashboard') }}">Dashboard</a>
<a href="{{ url_for('forms.daily_monitoring') }}" class="active">Daily Monitoring</a>
<a href="{{ url_for('views.monitoring_history') }}">View History</a>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Daily Monitoring Form</h2>
        <p style="color: #64748b; margin-top: 0.5rem;">Record equipment monitoring data</p>
    </div>
    
    <form id="monitoringForm" style="padding: 1.5rem;">
        <input type="hidden" id="monitoring_id" name="monitoring_id">
        
        <div class="form-group">
            <label class="form-label" for="equipment_id">Equipment *</label>
            <select class="form-select" id="equipment_id" name="equipment_id" required>
                <option value="">-- Select Equipment --</option>
                {% for eq in equipment %}
                <option value="{{ eq.id }}">{{ eq.equipment_code }} - {{ eq.equipment_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="grid grid-2">
            <div class="form-group">
                <label class="form-label" for="monitoring_date">Date *</label>
                <input type="date" class="form-input" id="monitoring_date" name="monitoring_date" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="shift">Shift *</label>
                <select class="form-select" id="shift" name="shift" required>
                    <option value="">-- Select Shift --</option>
                    <option value="morning">Morning</option>
                    <option value="afternoon">Afternoon</option>
                    <option value="night">Night</option>
                </select>
            </div>
        </div>
        
        <div class="card" style="margin: 1.5rem 0; padding: 1rem; background-color: #f8fafc;">
            <h3 style="margin-bottom: 1rem; color: #1e293b;">Readings</h3>
            <div class="grid grid-3">
                <div class="form-group">
                    <label class="form-label" for="voltage">Voltage (V) *</label>
                    <input type="number" step="0.1" class="form-input" id="voltage" name="voltage" required placeholder="230.0">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="current">Current (A) *</label>
                    <input type="number" step="0.1" class="form-input" id="current" name="current" required placeholder="50.0">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="power_factor">Power Factor *</label>
                    <input type="number" step="0.01" min="0" max="1" class="form-input" id="power_factor" name="power_factor" required placeholder="0.95">
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="operational_status">Status *</label>
            <select class="form-select" id="operational_status" name="operational_status" required>
                <option value="">-- Select Status --</option>
                <option value="normal">Normal</option>
                <option value="warning">Warning</option>
                <option value="critical">Critical</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="observations">Observations</label>
            <textarea class="form-textarea" id="observations" name="observations" rows="3" placeholder="Any additional notes..."></textarea>
        </div>
        
        <div id="errorMessage" style="display: none; padding: 1rem; background-color: #fee; color: #c33; border-radius: 6px; margin-bottom: 1rem;"></div>
        <div id="successMessage" style="display: none; padding: 1rem; background-color: #efe; color: #3c3; border-radius: 6px; margin-bottom: 1rem;"></div>
        
        <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary" id="submitBtn">Save Record</button>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
            <a href="{{ url_for('views.monitoring_history') }}" class="btn btn-secondary">View History</a>
        </div>
    </form>
</div>

<!-- Recent Records -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">Recent Records</h3>
        <button type="button" class="btn btn-sm btn-secondary" onclick="loadRecentRecords()">Refresh</button>
    </div>
    <div class="table-container">
        <table id="recentRecordsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Equipment</th>
                    <th>Voltage</th>
                    <th>Current</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="6" class="empty-state">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set today's date as default
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('monitoring_date');
        if (dateInput && !dateInput.value) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
        loadRecentRecords();
    });
    
    // Form submission
    document.getElementById('monitoringForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const errorDiv = document.getElementById('errorMessage');
        const successDiv = document.getElementById('successMessage');
        const form = e.target;
        
        // Hide messages
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        
        // Validate form
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Collect form data
        const formData = {
            equipment_id: document.getElementById('equipment_id').value,
            monitoring_date: document.getElementById('monitoring_date').value,
            shift: document.getElementById('shift').value,
            voltage: parseFloat(document.getElementById('voltage').value),
            current: parseFloat(document.getElementById('current').value),
            power_factor: parseFloat(document.getElementById('power_factor').value),
            operational_status: document.getElementById('operational_status').value,
            observations: document.getElementById('observations').value || null
        };
        
        const monitoringId = document.getElementById('monitoring_id').value;
        const isEdit = monitoringId && monitoringId !== '';
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';
        
        try {
            const url = isEdit ? `/api/monitoring/${monitoringId}` : '/api/monitoring';
            const method = isEdit ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                successDiv.textContent = isEdit ? 'Record updated successfully!' : 'Record saved successfully!';
                successDiv.style.display = 'block';
                clearForm();
                loadRecentRecords();
                
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            } else {
                errorDiv.textContent = result.message || 'Error saving record. Please try again.';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'Network error. Please check your connection and try again.';
            errorDiv.style.display = 'block';
            console.error('Error:', error);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Record';
        }
    });
    
    // Clear form
    function clearForm() {
        document.getElementById('monitoringForm').reset();
        document.getElementById('monitoring_id').value = '';
        const dateInput = document.getElementById('monitoring_date');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
    }
    
    // Load recent records
    async function loadRecentRecords() {
        try {
            const response = await fetch('/api/monitoring/technician?limit=10');
            const result = await response.json();
            
            const tbody = document.querySelector('#recentRecordsTable tbody');
            if (result.success && result.data && result.data.length > 0) {
                tbody.innerHTML = result.data.map(record => `
                    <tr>
                        <td>${new Date(record.monitoring_date).toLocaleDateString()}</td>
                        <td>Equipment #${record.equipment_id}</td>
                        <td>${record.voltage || '-'} V</td>
                        <td>${record.current || '-'} A</td>
                        <td><span class="status-badge status-${record.operational_status}">${record.operational_status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editRecord(${record.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRecord(${record.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No records found</td></tr>';
            }
        } catch (error) {
            console.error('Error loading records:', error);
            const tbody = document.querySelector('#recentRecordsTable tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Error loading records</td></tr>';
        }
    }
    
    // Edit record
    async function editRecord(id) {
        try {
            const response = await fetch(`/api/monitoring/${id}`);
            const result = await response.json();
            
            if (result.success && result.data) {
                const record = result.data;
                document.getElementById('monitoring_id').value = record.id;
                document.getElementById('equipment_id').value = record.equipment_id;
                document.getElementById('monitoring_date').value = record.monitoring_date ? record.monitoring_date.split('T')[0] : '';
                document.getElementById('shift').value = record.shift || '';
                document.getElementById('voltage').value = record.voltage || '';
                document.getElementById('current').value = record.current || '';
                document.getElementById('power_factor').value = record.power_factor || '';
                document.getElementById('operational_status').value = record.operational_status || '';
                document.getElementById('observations').value = record.observations || '';
                
                document.getElementById('submitBtn').textContent = 'Update Record';
                document.getElementById('monitoringForm').scrollIntoView({ behavior: 'smooth' });
            } else {
                showToast('Record not found', 'error');
            }
        } catch (error) {
            showToast('Error loading record', 'error');
            console.error('Error:', error);
        }
    }
    
    // Delete record
    async function deleteRecord(id) {
        if (!confirm('Are you sure you want to delete this record? This cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/monitoring/${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Record deleted successfully', 'success');
                loadRecentRecords();
            } else {
                showToast(result.message || 'Error deleting record', 'error');
            }
        } catch (error) {
            showToast('Network error. Please try again.', 'error');
            console.error('Error:', error);
        }
    }
</script>
{% endblock %}

