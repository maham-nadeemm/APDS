{% extends "base.html" %}

{% block title %}Draft Resolution Report{% endblock %}

{% block sidebar_menu %}
<a href="{{ url_for('dashboard.engineer_dashboard') }}">Dashboard</a>
<a href="{{ url_for('forms.root_cause_analysis') }}">Root Cause Analysis</a>
<a href="{{ url_for('forms.draft_resolution') }}" class="active">Draft Resolution</a>
<a href="{{ url_for('views.fault_list') }}">Fault List</a>
{% endblock %}

{% block content %}
{% if fault %}
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h2 class="card-title">Fault Information</h2>
    </div>
    <div style="padding: 1.5rem;">
        <p><strong>Fault ID:</strong> #{{ fault.id }}</p>
        <p><strong>Description:</strong> {{ fault.fault_description }}</p>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Draft Resolution Report</h2>
    </div>
    <form id="reportForm" class="form-container" style="padding: 1.5rem;">
        {% if fault %}
        <input type="hidden" id="fault_id" name="fault_id" value="{{ fault.id }}">
        {% else %}
        <div class="form-group">
            <label class="form-label" for="fault_id">Fault ID *</label>
            <input type="number" class="form-input" id="fault_id" name="fault_id" required>
        </div>
        {% endif %}
        
        <div class="form-group">
            <label class="form-label" for="resolution_description">Resolution Description *</label>
            <textarea class="form-textarea" id="resolution_description" name="resolution_description" rows="6" required placeholder="Describe how the fault was resolved..."></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="actions_taken">Actions Taken *</label>
            <textarea class="form-textarea" id="actions_taken" name="actions_taken" rows="6" required placeholder="List all actions taken to resolve the fault..."></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="preventive_measures">Preventive Measures</label>
            <textarea class="form-textarea" id="preventive_measures" name="preventive_measures" rows="4" placeholder="Describe preventive measures to avoid recurrence..."></textarea>
        </div>
        
        <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary">Save as Draft</button>
            <button type="button" class="btn btn-success" id="submitForApproval">Submit for Approval</button>
            <a href="{{ url_for('dashboard.engineer_dashboard') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let reportId = null;
    
    document.getElementById('reportForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            fault_id: document.getElementById('fault_id').value,
            resolution_description: document.getElementById('resolution_description').value,
            actions_taken: document.getElementById('actions_taken').value,
            preventive_measures: document.getElementById('preventive_measures').value || null
        };
        
        try {
            const response = await fetch('/api/reports', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                reportId = result.data.id;
                showToast('Draft report saved successfully!', 'success');
            } else {
                showToast(result.message || 'Error saving report', 'error');
            }
        } catch (error) {
            showToast('Network error. Please try again.', 'error');
        }
    });
    
    document.getElementById('submitForApproval').addEventListener('click', async function() {
        if (!reportId) {
            showToast('Please save the draft first', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/reports/${reportId}/submit`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Report submitted for approval!', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard/engineer?refresh=' + Date.now();
                }, 1500);
            } else {
                showToast(result.message || 'Error submitting report', 'error');
            }
        } catch (error) {
            showToast('Network error. Please try again.', 'error');
        }
    });
</script>
{% endblock %}

